<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>副業適性 精密診断Pro（MNP・TickTok自演招待・物販細分化・FX）</title>
<meta name="description" content="MNP / TickTok（自演招待） / 物販（抽選・電脳・無在庫・ポケカ/PSAほか細分化） / FX の適性をスコア化。『一番向いている／二番目に向いている』＋おすすめスタイルを表示。診断前の要約は空。">
<style>
#shdpro-app, #shdpro-app * { box-sizing: border-box; }
#shdpro-app {
  --card:#ffffff; --muted:#4b5563; --ink:#0b1020;
  --accent:#0ea5e9; --accent-2:#2563eb; --border:#e5e7eb;
  --chip:#f3f4f6; --shadow:0 6px 20px rgba(0,0,0,.12);
  color:var(--ink); background:#eef3f8; padding:2px;
  --bar-h:26px;
}
.shdpro-wrap { max-width:720px; margin:18px auto 60px; padding:0 14px; }
.shdpro-title { font-weight:800; letter-spacing:.02em; font-size:clamp(22px,3.4vw,32px); margin:2px 0 10px; }
.shdpro-sub { color:var(--muted); font-size:13px; margin-bottom:16px; }
.shdpro-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; margin:12px 0; box-shadow:var(--shadow); }
.shdpro-row { display:grid; grid-template-columns:1fr; gap:12px; }
.shdpro-controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.shdpro-btn { cursor:pointer; background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff; border:0; border-radius:11px; padding:10px 14px; font-weight:700; font-size:14px; box-shadow:0 6px 12px rgba(0,0,0,.15); }
.shdpro-btn.outline { background:transparent; color:var(--ink); border:1px solid var(--border); }
.shdpro-chip { display:inline-flex; align-items:center; gap:6px; background:var(--chip); color:var(--muted); border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; }

.shdpro-q { display:grid; gap:6px; margin:10px 0 16px; }
.shdpro-q h4 { margin:0; font-size:14px; font-weight:800; }
.shdpro-q small { color:var(--muted); font-size:12px; }
.shdpro-labels { display:flex; justify-content:space-between; font-size:11px; color:var(--muted); }
.shdpro-opts { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; }
.shdpro-opt { appearance:none; border:1px solid var(--border); background:var(--chip); color:var(--ink); border-radius:10px; padding:12px 0; font-weight:800; text-align:center; cursor:pointer; user-select:none; }
.shdpro-opt[aria-checked="true"] { background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff; border-color:transparent; box-shadow:0 6px 12px rgba(0,0,0,.15); }

.shdpro-sec-title { margin:8px 0 0; font-weight:800; font-size:15px; color:var(--accent-2); border-left:4px solid var(--accent-2); padding-left:8px; }

.shdpro-bars { display:grid; gap:10px; margin-top:6px; }
.shdpro-bar { background:var(--chip); border:1px solid var(--border); border-radius:999px; position:relative; overflow:hidden; }
.shdpro-bar>span { display:block; height:var(--bar-h); background:linear-gradient(90deg,var(--accent-2),var(--accent)); }
.shdpro-bar .shdpro-bar-label { position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; padding:0 12px; font-size:12px; min-height:var(--bar-h); color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.45); }
.shdpro-bar .shdpro-bar-label span:last-child { color:#000; text-shadow:none; } /* ％は黒 */

table { width:100%; border-collapse:collapse; }
th, td { border:1px solid var(--border); padding:8px 10px; font-size:13px; vertical-align:top; }
th { text-align:left; background:var(--chip); }
.shdpro-footer { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:8px; }
.shdpro-center { text-align:center; }

#shdpro-fatal { display:none; background:#fff7cc; color:#4a3b00; border:1px solid #ffe38a; border-radius:12px; padding:10px; margin:12px 0; }
#shdpro-admin-ribbon { position:sticky; top:0; z-index:10; background:rgba(37,99,235,.06); border:1px dashed var(--border); border-radius:12px; padding:8px 12px; margin:12px 0; }
</style>
</head>
<body>

<!-- REMOTE_VERSION を上げると weights.json を確実に再取得 -->
<div id="shdpro-app" data-admin-pin="1357" data-remote-version="11" data-weights-url="weights.json">
  <div class="shdpro-wrap">

    <!-- ヘッダー -->
    <div class="shdpro-card" style="background:linear-gradient(135deg, rgba(38,99,235,.06), rgba(42,161,152,.05));">
      <div class="shdpro-title">副業適性 精密診断Pro</div>
      <div class="shdpro-sub">1〜5のタップ回答で <b>MNP / TickTok（自演招待） / 物販（細分化） / FX</b> のスコアを算出します。※参考情報です。</div>
      <div class="shdpro-controls">
        <button class="shdpro-btn outline" id="btn-print">印刷 / PDF保存</button>
        <button class="shdpro-btn outline" id="btn-copy">結果をコピー</button>
        <button class="shdpro-btn outline" id="btn-reset">一括リセット</button>
      </div>
      <div id="shdpro-fatal" role="alert" aria-live="polite"></div>
    </div>

    <!-- 管理リボン -->
    <div id="shdpro-admin-ribbon" class="shdpro-card" style="display:none;">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <b>管理者モード</b>
        <small id="admin-version" class="shdpro-sub" style="margin:0;"></small>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <label class="shdpro-chip"><input type="checkbox" id="admin-toggle-debug"> <span>ロジック表示</span></label>
        <button class="shdpro-btn outline" id="admin-toggle-adv">高度な設定</button>
        <button class="shdpro-btn outline" id="admin-download-weights">公開用JSONをダウンロード</button>
        <a class="shdpro-btn outline" id="admin-open-weights" href="#" target="_blank" rel="noopener">weights.json を開く</a>
        <button class="shdpro-btn outline" id="admin-exit">終了</button>
      </div>
    </div>

    <!-- 設問 -->
    <div class="shdpro-card">
      <div id="questions"></div>
      <div class="shdpro-footer" style="justify-content:center;">
        <button class="shdpro-btn" id="btn-diagnose">診断する</button>
      </div>
      <div class="shdpro-footer"><span class="shdpro-sub">※各質問の1〜5をタップ → 一番下の「診断する」。結果は自動保存されます。</span></div>
    </div>

    <!-- 診断結果 -->
    <div class="shdpro-card" id="result-card" style="display:none;">
      <div class="shdpro-row">
        <div>
          <h3 style="margin:0 0 8px;">診断スコア</h3>
          <div class="shdpro-bars" id="bars"></div>
        </div>
        <div>
          <h3 style="margin:12px 0 6px;">おすすめスタイル</h3>
          <div id="subtype-wrap"></div>
          <h3 style="margin:12px 0 8px;">要約</h3>
          <div id="summary" class="shdpro-sub" style="line-height:1.6;color:var(--ink);"></div>
        </div>
      </div>
      <div id="debug" style="display:none; margin-top:12px;" class="shdpro-sub"></div>
    </div>

    <!-- 高度な設定 -->
    <div class="shdpro-card" id="advanced-box" style="display:none;">
      <details open>
        <summary>スコア重み（上級者向け）</summary>
        <div class="shdpro-sub">各設問が <b>MNP / TickTok（自演招待） / 物販（細分化） / FX</b> にどれだけ寄与するか（-1.0〜+1.0）。変更後は自動保存。</div>
        <table id="weights-table"></table>
      </details>
      <div class="shdpro-footer">
        <button class="shdpro-btn outline" id="btn-weights-reset">重みを既定に戻す</button>
        <button class="shdpro-btn outline" id="btn-export">設定を書き出し（JSON）</button>
        <label class="shdpro-btn outline" for="file-import" style="cursor:pointer;">設定を読み込み（JSON）</label>
        <input id="file-import" type="file" accept="application/json" style="display:none;">
      </div>
    </div>

    <div class="shdpro-center shdpro-sub">© Zeroichi Lab</div>
  </div>
</div>

<script type="application/json" id="embedded-weights">
{ "configVersion": 11, "weights": {}, "subtypes": {} }
</script>

<script>
(function(){
  const root = document.getElementById('shdpro-app'); if(!root) return;
  const $  = (s, c=document) => c.querySelector(s);
  const $$ = (s, c=document) => Array.from(c.querySelectorAll(s));

  const ADMIN_PIN  = root.dataset.adminPin || '1357';
  const REMOTE_VERSION = root.dataset.remoteVersion || '1';
  const STORE_KEY  = 'shdpro_state_v11';
  const CAT = ['MNP','TickTok','物販','FX'];

  // 設問定義（FXのQ9は存在しない版／物販にq26〜q32を追加して細分化）
  const QDEF = [
    // MNP
    {key:'q3',  t:'申し込み・契約・解約などの手続きをコツコツ進められる？', h:'1=苦手 / 5=得意・むしろ好き', section:'MNP'},
    {key:'q6',  t:'店舗に行ったり電話で確認するのは平気？',                 h:'1=避けたい / 5=問題なくできる', section:'MNP'},
    {key:'q14', t:'携帯料金やキャンペーンの仕組みに詳しい？',                 h:'1=あまり詳しくない / 5=かなり詳しい', section:'MNP'},
    {key:'q15', t:'店員さんや電話での交渉・確認は得意？',                     h:'1=苦手 / 5=得意', section:'MNP'},
    {key:'q16', t:'特典条件や期日を漏れなく管理できる？',                     h:'1=管理が苦手 / 5=抜け漏れが少ない', section:'MNP'},
    {key:'q25', t:'あなたは個人事業主（開業届）または法人の代表者ですか？',  h:'1=いいえ / 3=準備中 / 5=はい', section:'MNP'},

    // TickTok（自演招待）
    {key:'q5',  t:'招待手順（初期設定→コード投入→成果確認）を他人に説明できる？', h:'1=説明が苦手 / 5=手順を簡潔に案内できる', section:'TickTok'},
    {key:'q21', t:'端末初期化・プロファイル作成・アプリ入替など反復作業に慣れている？', h:'1=ほぼできない / 5=得意でミスが少ない', section:'TickTok'},
    {key:'q22', t:'アカウント衛生（同一端末NG/同一回線回避/冷却期間など）を厳守できる？', h:'1=守るのが苦手 / 5=厳守できる', section:'TickTok'},
    {key:'q24', t:'毎日短時間でも招待サイクルを途切れず回せる？',           h:'1=難しい / 5=毎日でも続けられる', section:'TickTok'},
    {key:'q20', t:'ペイ/ポイント→換金のルートや上限管理の基礎を理解している？', h:'1=ほぼ知らない / 5=基礎はある', section:'TickTok'},

    // 物販（細分化：抽選・電脳・無在庫・ポケカ/PSA・買取回転・海外EC）
    {key:'q1',  t:'最初に使える予算は用意できる？（抽選当選の即支払い・PSA費用を含む）', h:'1=ほぼゼロ / 5=十分に用意できる', section:'物販'},
    {key:'q2',  t:'在庫や梱包・発送、カードのスリーブ・保護などの作業は大丈夫？', h:'1=避けたい / 5=抵抗はない', section:'物販'},
    {key:'q8',  t:'早く現金化できることはどれくらい大事？（抽選当選直売/即日買取など）', h:'1=急がない / 5=できるだけ早い方がよい', section:'物販'},
    {key:'q17', t:'抽選応募や当落/発売日管理など、ポケカ抽選の運用を継続できる？', h:'1=続かない / 5=楽しく続けられる', section:'物販'},
    {key:'q18', t:'電脳リサーチ（価格履歴・相場比較・買取表）を習慣化できる？',   h:'1=続かない / 5=楽しく続けられる', section:'物販'},
    {key:'q19', t:'返品・問い合わせ・真贋チェック・状態評価（白欠け等）に落ち着いて対応できる？', h:'1=とても苦手 / 5=問題なく対応できる', section:'物販'},
    {key:'q20b',t:'PSA提出（封入・申請・返送）やセンタリング基準の基礎を理解している？', h:'1=ほぼ知らない / 5=基礎はある', section:'物販'},
    {key:'q26', t:'複数アカウントでの抽選応募・当落表の管理を正確に運用できる？', h:'1=不安 / 5=正確に回せる', section:'物販'},
    {key:'q27', t:'価格履歴ツール（例: Keepa 相当）で仕入れ判断ができる？',   h:'1=ほぼ使えない / 5=指標を使いこなせる', section:'物販'},
    {key:'q28', t:'支払日・着金日を見越したキャッシュフローを計画できる？',     h:'1=計画が苦手 / 5=計画的に回せる', section:'物販'},
    {key:'q29', t:'PSA提出の封入・発送・申請・センタリング判定を自走できる？',   h:'1=難しい / 5=ほぼ自走できる', section:'物販'},
    {key:'q30', t:'無在庫販売のツール運用（在庫同期・価格改定・キャンセル率管理）に対応できる？', h:'1=難しい / 5=問題なく運用できる', section:'物販'},
    {key:'q31', t:'即日買取の相場表更新を追い、店舗比較で回転率を上げられる？', h:'1=追うのは難しい / 5=常時チェックしている', section:'物販'},
    {key:'q32', t:'海外EC（輸入）で関税・遅延・返品などのリスクを許容できる？', h:'1=難しい / 5=許容して運用できる', section:'物販'},

    // FX（Q9なし）
    {key:'q4',  t:'価格が上下しても落ち着いていられる？',              h:'1=少しの上下でも不安 / 5=落ち着いて判断できる', section:'FX'},
    {key:'q7',  t:'ツールや自動化で作業を楽にしたい？',                  h:'1=あまり使わない / 5=積極的に使いたい', section:'FX'},
    {key:'q10', t:'お金の増減にどのくらい耐えられる？',                  h:'1=上下はほぼ無理 / 5=ある程度の上下は大丈夫', section:'FX'},
    {key:'q11', t:'チャートを見て分析するのは得意？',                    h:'1=苦手 / 5=好きで深く理解したい', section:'FX'},
    {key:'q12', t:'損切りや資金管理など、決めたルールを守れる？',        h:'1=続かない / 5=きっちり守れる', section:'FX'},
    {key:'q13', t:'ポジションを翌日まで持ち越しても平気？',              h:'1=無理 / 5=問題ない', section:'FX'}
  ];
  const QLABEL = Object.fromEntries(QDEF.map(q=>[q.key,q.t]));

  // 状態
  const EMBED = JSON.parse(document.getElementById('embedded-weights').textContent);
  let DEFAULT_WEIGHTS = {};
  let SUB_WEIGHTS = {};
  let state = load() || {
    advanced:false, debug:false, autosave:true,
    answers: Object.fromEntries(QDEF.map(q=>[q.key,3])),
    weights: DEFAULT_WEIGHTS, remoteVersion: 0, diagnosed:false
  };
  let isAdmin = (localStorage.getItem('shd_admin') === '1');

  (async function init(){
    await loadRemoteConfig();
    renderQuestions(); mountOptionControls();
    buildWeightsTable(); bindPublic(); bindAdmin();
    bootAdmin();
    $('#summary').textContent = '';
    $('#result-card').style.display = state.diagnosed ? 'block' : 'none';
    if(state.diagnosed) diagnose();
    renderAdminUI();
  })();

  function buildDefaultURL(){
    const attr = root.dataset.weightsUrl || 'weights.json';
    const a = document.createElement('a'); a.href = attr;
    const ver = encodeURIComponent(REMOTE_VERSION || '1');
    return a.href + (a.href.includes('?') ? '&' : '?') + 'v=' + ver;
  }
  async function loadRemoteConfig(){
    DEFAULT_WEIGHTS = EMBED.weights || {};
    SUB_WEIGHTS     = EMBED.subtypes || {};
    const url = buildDefaultURL();
    try{
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const cfg = await res.json();
      const remoteVer = (cfg && (cfg.configVersion ?? 0)) | 0;
      if(cfg && cfg.weights) DEFAULT_WEIGHTS = cfg.weights;
      if(cfg && cfg.subtypes) SUB_WEIGHTS = cfg.subtypes;
      state.weights = DEFAULT_WEIGHTS; state.remoteVersion = remoteVer; saveMaybe();
      $('#admin-open-weights').setAttribute('href', url.replace(/\?v=.*/,''));
      $('#admin-version').textContent = `グローバル設定 v${state.remoteVersion ?? 0}（REMOTE_VERSION=${REMOTE_VERSION}）`;
    }catch(err){
      if(isAdmin){
        const box = $('#shdpro-fatal');
        if(box){ box.style.display = 'block'; box.textContent = 'weights.json の取得に失敗。内蔵設定で動作中。'; }
      }
    }
  }

  function renderQuestions(){
    const wrap = $('#questions'); wrap.innerHTML = '';
    let qnum = 1;
    const sections = ['MNP','TickTok','物販','FX'];
    sections.forEach(sec=>{
      const secTitle = document.createElement('h3');
      secTitle.className = 'shdpro-sec-title';
      secTitle.textContent = sec; wrap.appendChild(secTitle);
      QDEF.filter(q=>q.section===sec).forEach(q=>{
        const el = document.createElement('div');
        el.className = 'shdpro-q'; el.dataset.key = q.key;
        el.innerHTML = `
          <h4>Q${qnum}. ${q.t}</h4>
          <small>${q.h}</small>
          <div class="shdpro-opts" role="radiogroup" aria-label="Q${qnum}. ${q.t}"></div>
          <div class="shdpro-labels"><span>低い/苦手</span><span>高い/得意</span></div>`;
        wrap.appendChild(el); qnum++;
      });
    });
  }

  function bindPublic(){
    $('#btn-diagnose').addEventListener('click', ()=>{ state.diagnosed=true; diagnose(); });
    $('#btn-copy').addEventListener('click', copyAll);
    $('#btn-print').addEventListener('click', ()=>window.print());
    $('#btn-reset').addEventListener('click', ()=>{
      if(confirm('回答と重みを既定に戻します。よろしいですか？')){
        state.answers = Object.fromEntries(QDEF.map(q=>[q.key,3]));
        state.weights = JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
        state.diagnosed=false;
        renderQuestions(); mountOptionControls(); buildWeightsTable();
        $('#result-card').style.display='none'; $('#summary').textContent='';
        saveMaybe();
      }
    });
  }

  function bindAdmin(){
    $('#admin-toggle-adv').addEventListener('click', ()=>{ state.advanced=!state.advanced; saveMaybe(); renderAdminUI(); });
    $('#admin-toggle-debug').addEventListener('change', (e)=>{ state.debug=e.target.checked; saveMaybe(); renderAdminUI(); });
    $('#admin-exit').addEventListener('click', ()=> setAdmin(false));
    $('#admin-download-weights').addEventListener('click', ()=>{
      const payload = { configVersion: (state.remoteVersion|0)+1, weights: state.weights, subtypes: SUB_WEIGHTS };
      exportJSON(payload, 'weights.json');
    });
  }
  function bootAdmin(){
    const url = new URL(location.href);
    const qp = url.searchParams.get('admin');
    if(qp && qp===ADMIN_PIN){ setAdmin(true); history.replaceState({},'',location.pathname+location.search.replace(/([?&])admin=[^&]+&?/,'$1').replace(/[?&]$/,'')); }
    const titleEl = $('.shdpro-title'); let taps=0, first=0, WIN=600;
    titleEl.addEventListener('pointerdown', ()=>{
      const now=Date.now(); if(!first||now-first>WIN){ first=now; taps=0; }
      taps++; if(taps>=3 && (now-first)<=WIN){ const pin=prompt('管理PINを入力'); if(pin===ADMIN_PIN) setAdmin(true); taps=0; first=0; }
    });
    if(isAdmin) renderAdminUI();
  }
  function setAdmin(flag){ isAdmin=!!flag; localStorage.setItem('shd_admin', isAdmin?'1':'0'); renderAdminUI(); }
  function renderAdminUI(){
    $('#shdpro-admin-ribbon').style.display = isAdmin ? 'block' : 'none';
    $('#advanced-box').style.display = (isAdmin && state.advanced) ? 'block' : 'none';
    $('#debug').style.display       = (isAdmin && state.debug)     ? 'block' : 'none';
    const dbg = $('#admin-toggle-debug'); if(dbg) dbg.checked = !!state.debug;
    const ver = $('#admin-version'); if(ver) ver.textContent = `グローバル設定 v${state.remoteVersion ?? 0}（REMOTE_VERSION=${REMOTE_VERSION}）`;
  }

  function mountOptionControls(){
    QDEF.forEach(q=>{
      const rootQ = document.querySelector(`.shdpro-q[data-key="${q.key}"]`);
      const wrap = $('.shdpro-opts', rootQ); if(!wrap) return; wrap.innerHTML = '';
      for(let i=1;i<=5;i++){
        const b=document.createElement('button');
        b.type='button'; b.className='shdpro-opt'; b.dataset.val=i;
        b.setAttribute('role','radio'); b.setAttribute('aria-checked', (state.answers[q.key]===i).toString());
        b.textContent = i;
        b.addEventListener('click', ()=>{
          state.answers[q.key]=i;
          $$('.shdpro-opt', wrap).forEach(btn=> btn.setAttribute('aria-checked', (btn===b).toString()));
          saveMaybe();
        });
        wrap.appendChild(b);
      }
    });
  }

  function diagnose(){
    const ans = state.answers, W = state.weights;
    const maxTheo = Object.fromEntries(CAT.map(c=>[c,0]));
    const raw     = Object.fromEntries(CAT.map(c=>[c,0]));
    const rows = [];
    QDEF.forEach(q=>{
      const v=ans[q.key], contrib={};
      CAT.forEach(c=>{
        const w=(W[q.key] && W[q.key][c])||0;
        raw[c]+=w*v;
        maxTheo[c]+= w>=0 ? w*5 : w*1;
        contrib[c]=w*v;
      });
      rows.push({q:q.key, v, contrib});
    });
    const scores={}; CAT.forEach(c=>{ let m=maxTheo[c]; if(m===0) m=1; let s=(raw[c]/m)*100; scores[c]=Math.max(0, Math.min(100, s)); });
    renderBars(scores); renderSubtypes(scores); renderSummary(scores, rows);
    $('#result-card').style.display='block'; saveMaybe();
  }

  function renderBars(scores){
    const wrap = $('#bars'); if(!wrap) return;
    const items = CAT.map(c=>({c, v:Math.round(scores[c])})).sort((a,b)=> b.v-a.v);
    wrap.innerHTML = items.map(it=>`
      <div class="shdpro-bar">
        <span style="width:${it.v}%;"></span>
        <div class="shdpro-bar-label"><b>${it.c}</b><span>${it.v}%</span></div>
      </div>`).join('');
  }

  function renderSubtypes(mainScores){
    const host = document.getElementById('subtype-wrap'); if(!host) return;
    host.innerHTML = '';
    const ranking = Object.entries(mainScores).map(([c,v])=>({c, v:Math.round(v)})).sort((a,b)=> b.v-a.v);
    const top = ranking[0], second = ranking[1];
    const targets = [top].concat((second && top.v-second.v<=5)?[second]:[]);
    targets.forEach(t=>{
      const subs = scoreSubtypes(t.c); if(!subs || subs.length===0) return;
      const section=document.createElement('div');
      section.innerHTML = `<h4 class="shdpro-sec-title" style="margin-top:12px;">${t.c} のおすすめスタイル</h4>`;
      const bars=document.createElement('div'); bars.className='shdpro-bars';
      bars.innerHTML = subs.map(s=>`
        <div class="shdpro-bar">
          <span style="width:${s.v}%"></span>
          <div class="shdpro-bar-label"><b>${s.name}</b><span>${s.v}%</span></div>
        </div>`).join('');
      section.appendChild(bars);

      const HINT={
        // TickTok（自演招待）
        '自演招待（Lite/本家）':'維持中SIMで安全に積み上げ。端末台数・アカ衛生管理・招待サイクル最適化が命。',
        'MNP連動招待強化':'MNPの維持期間と招待サイクルを同期。還元→換金→在庫化の回転率を最大化。',

        // 物販（細分化）
        '店舗せどり（予約購入）':'予約カレンダー×買取相場を同期。即金性重視。',
        '抽選購入（限定/家電/ゲーム機）':'複垢・当落表の正確運用で当選率と回転率を両立。',
        '電脳リサーチ（価格履歴）':'価格履歴とトレンドで再現性のある仕入れを組む。',
        '無在庫（ツール運用）':'在庫同期・価格改定・キャンセル率の管理が生命線。',
        'ポケカ：新弾抽選即売':'抽選→即売の導線固定。抽選日/発売日管理が肝。',
        'ポケカ：寝かし投資':'価格推移と需要周期を読む。資金拘束を許容できるかが鍵。',
        'ポケカ：単体PSA提出':'センタリング判定と封入手順の精度が利益を左右。',
        '買取回転（即日特化）':'買取表の更新監視と店舗比較で回転率を最大化。',
        '海外EC併用（輸入）':'為替や関税・遅延リスクを許容して粗利を積む。',

        // MNP
        '店舗契約（個人）':'維持期間・回線管理をシート化。現地特典の差を拾う。',
        '法人契約（複数回線）':'前提：個人事業主/法人。回線枠とCF管理を厳密に。',
        '家族・身内回線拡張':'支払いは自分に集約。名義は家族で枠拡張。',
        'MNP紹介（手数料）':'友人知人に最短ルート。条件は事前合意。',

        // FX（サロン仕様）
        'ゴトー日トレード':'月6回の局面に限定。準備リストで負荷最小化。',
        '指標トレード':'発表「後」の一方向だけを狙う。直前のEA停止・約定管理。',
        '両建てトレード':'ヘッジ→崩し手順を固定し理論を踏み外さない。',
        'EA（GOLD）':'指標前停止・DD上限・資金管理を先に定義。'
      };
      const top1=subs[0]; const p=document.createElement('p'); p.className='shdpro-sub'; p.style.marginTop='4px';
      p.textContent=`まずは「${top1.name}」から着手。${HINT[top1.name]||''}`;
      section.appendChild(p);

      if(t.c==='MNP'){
        const q25 = (state.answers['q25']||3);
        const needsBiz = subs.some(s=> s.name.includes('法人契約'));
        if(needsBiz){
          const warn=document.createElement('p'); warn.className='shdpro-sub'; warn.style.marginTop='4px';
          if(q25<=2){ warn.innerHTML='※ <b>法人契約は「個人事業主/法人代表」が前提</b>です。今は要件未満なので、まずは「店舗契約（個人）」などから。'; }
          else if(q25===3){ warn.textContent='※ 法人契約の前提はほぼ満たせそう。開業届や設立完了で有利になります。'; }
          else { warn.textContent='※ 前提クリア済み。回線枠と資金繰りの設計を先に作りましょう。'; }
          section.appendChild(warn);
        }
      }
      host.appendChild(section);
    });
  }

  function scoreSubtypes(category){
    const defs = SUB_WEIGHTS[category]; if(!defs) return null;
    const items = Object.keys(defs).map(name=>{
      let raw=0, maxTheo=0; const map=defs[name];
      Object.keys(map).forEach(qk=>{
        const w=map[qk]||0; const v=state.answers[qk]||3;
        raw += w*v; maxTheo += w>=0 ? w*5 : w*1;
      });
      if(maxTheo===0) maxTheo=1;
      let s=Math.max(0, Math.min(100, (raw/maxTheo)*100));
      return { name, v:Math.round(s) };
    });
    return items.sort((a,b)=> b.v-a.v);
  }

  function renderSummary(scores, rows){
    const items = CAT.map(c=>({c, v:Math.round(scores[c])})).sort((a,b)=> b.v-a.v);
    const top = items[0], second = items[1];
    const hints = {
      MNP:'店舗中心。要件を満たせば法人枠で拡張しやすい。',
      TickTok:'自演招待を自分のペースで回し、回線や換金ルートと同期。',
      物販:'抽選・電脳・無在庫・ポケカ/PSA・買取回転・海外ECの型から着手。',
      FX:'ゴトー日/指標/両建て/EA（GOLD）で局面特化＋ルール徹底。'
    };
    $('#summary').innerHTML =
      `あなたに<b>一番向いている</b>のは <b>${top.c}</b>（${top.v}%）。` +
      (second && (top.v-second.v)<=5 ? ` 続いて<b>二番目に向いている</b>のは <b>${second.c}</b>（${second.v}%）。` : '') +
      `<br>示唆：${hints[top.c]}`;
    if(state.debug && isAdmin){
      let html = '<h4>診断ロジック詳細</h4><table><tr><th>設問</th>' + CAT.map(c=>`<th>${c}</th>`).join('') + '</tr>';
      rows.forEach(r=>{
        html += `<tr><td>${QLABEL[r.q]}（${r.q} / v=${r.v}）</td>` + CAT.map(c=>`<td>${(r.contrib[c]||0).toFixed(2)}</td>`).join('') + '</tr>';
      });
      html += '</table>'; $('#debug').innerHTML = html;
    }
  }

  function buildWeightsTable(){
    const tbl = $('#weights-table'); tbl.innerHTML = '';
    const head = document.createElement('tr'); head.innerHTML = `<th>設問</th>${CAT.map(c=>`<th>${c}</th>`).join('')}`; tbl.appendChild(head);
    QDEF.forEach(q=>{
      if(!state.weights[q.key]) state.weights[q.key] = Object.fromEntries(CAT.map(c=>[c,0]));
      const tr=document.createElement('tr');
      tr.innerHTML = `<th>${q.key}：${q.t}</th>` + CAT.map(c=>`<td><input data-q="${q.key}" data-cat="${c}" type="number" step="0.05" min="-1" max="1" value="${state.weights[q.key][c] ?? 0}" style="width:90px;"></td>`).join('');
      tbl.appendChild(tr);
    });
    $$('#weights-table input').forEach(inp=> inp.addEventListener('input', e=>{
      const q=e.target.getAttribute('data-q'); const c=e.target.getAttribute('data-cat');
      let v=parseFloat(e.target.value||'0'); if(isNaN(v)) v=0; v=Math.max(-1, Math.min(1, v)); e.target.value=v.toFixed(2);
      state.weights[q][c]=v; saveMaybe();
    }));
    $('#btn-weights-reset').addEventListener('click', ()=>{
      state.weights = JSON.parse(JSON.stringify(DEFAULT_WEIGHTS)); buildWeightsTable(); saveMaybe();
    });
    $('#btn-export').addEventListener('click', ()=> exportJSON({weights:state.weights, subtypes:SUB_WEIGHTS}, 'shd_settings.json') );
    $('#file-import').addEventListener('change', onImportJSON);
  }

  function copyAll(){
    const text = stripHtml($('#summary').innerHTML) + "\n\n" + barsText();
    navigator.clipboard.writeText(text).then(()=> alert('結果をコピーしました。')).catch(()=> alert('コピーに失敗しました。'));
  }
  function barsText(){ return $$('#bars .shdpro-bar').map(bar=> $('.shdpro-bar-label', bar).innerText.trim()).join('\n'); }
  function stripHtml(html){ const div=document.createElement('div'); div.innerHTML=html; return div.textContent||div.innerText||''; }
  function exportJSON(obj, filename){ const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
  function onImportJSON(e){
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=()=>{ try{ const data=JSON.parse(reader.result); if(data.weights){state.weights=data.weights;} if(data.subtypes){SUB_WEIGHTS=data.subtypes;} buildWeightsTable(); saveMaybe(); alert('設定を読み込みました。'); }catch(_){ alert('JSONの読み込みに失敗しました。'); } };
    reader.readAsText(f);
  }
  function saveMaybe(){ if(state.autosave){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); } }
  function load(){ try{ const s=localStorage.getItem(STORE_KEY); return s?JSON.parse(s):null; }catch(_){ return null; } }
})();
</script>
</body>
</html>
